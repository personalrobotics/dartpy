# dartpy [![Build Status](https://travis-ci.org/personalrobotics/dartpy.svg?branch=master)](https://travis-ci.org/personalrobotics/dartpy) #

> :warning: **Warning:** `dartpy` is under heavy development. See the open
> issues on [`dartpy`](https://github.com/personalrobotics/dartpy/issues) and
> [Chimera](https://github.com/personalrobotics/chimera/issues) for insight
> into the current state of the project. Please report any issues you
> encounter on the appropriate repository.

Python bindings for [DART][dart], the Dynamic Animation and Robotics Toolkit.

## Installation

### On Ubuntu using `apt-get`

#### Adding PPA

Several PPAs should be added to install the dependencies and `dartpy`.

##### Artful, Zesty, Xenial

```shell
$ sudo add-apt-repository ppa:dartsim/ppa
$ sudo add-apt-repository ppa:personalrobotics/ppa
```

##### Trusty

```shell
$ sudo add-apt-repository ppa:libccd-debs/ppa
$ sudo add-apt-repository ppa:fcl-debs/ppa
$ sudo add-apt-repository ppa:dartsim/ppa
$ sudo add-apt-repository ppa:personalrobotics/ppa
```

#### Installing `dartpy`

```shell
$ sudo apt-get update
$ sudo apt-get install python-dartpy  # for Python 2
$ sudo apt-get install python3-dartpy # for Python 3
```

All set! Import `dartpy` in Python and enjoy! Please see [Usage](#usage) section for more information.

## Building from Source

### Dependencies

* Boost.Python
* [Chimera][chimera] (only for generating new bindings)
* [Boost.Numpy][boost_numpy] (build from source)
* [Boost.Numpy/Eigen][boost_numpy_eigen] (build from source)
* [DART][dart]

### On Ubuntu using CMake

#### Adding PPA

Several PPAs should be added to install the dependencies.

##### Artful, Zesty, Xenial

```shell
$ sudo add-apt-repository ppa:dartsim/ppa
$ sudo add-apt-repository ppa:personalrobotics/ppa
```

##### Trusty

```shell
$ sudo add-apt-repository ppa:libccd-debs/ppa
$ sudo add-apt-repository ppa:fcl-debs/ppa
$ sudo add-apt-repository ppa:dartsim/ppa
$ sudo add-apt-repository ppa:personalrobotics/ppa
```

#### Installing Dependencies

```shell
$ sudo apt-get install cmake libboost-dev libboost-python-dev libboost-python-numpy-dev libdart6-all-dev
$ sudo apt-get install python-dev python-numpy python-boost-numpy-eigen    # for Python 2
$ sudo apt-get install python3-dev python3-numpy python3-boost-numpy-eigen # for Python 3
```

#### Building `dartpy`

> :warning: **Warning:** The Boost.Python bindings generated by may not build
> in GCC. We suggest that you use [Clang][clang] 3.7 or above to avoid
> potential issues. If you are on [Ubuntu 14.04][ubuntu1404], builds of Clang
> are available in the [LLVM Apt repository][llvm_apt].

`dartpy` uses the [CMake][cmake] build system. You should follow the standard CMake build
process. :
```console
$ cd <dartpy_root_directory>
$ mkdir build
$ cd build
$ cmake .. -DDARTPY_PYTHON_VERSION=3  # Use -DDARTPY_PYTHON_VERSION=2 to build for Python 2
```

Once the CMake configuration is complete, you can generate the Boost.Python bindings of `dartpy` by running:
```console
$ make binding
```
If you are using `dart-<version>-binding` (e.g., `dart-6.3-binding`) branch, you don't need to generate bindings as those branches already include generated bindings.

Once the binding generation is done, you can build and install `dartpy` by running:
```console
$ make  # you may want to build dartpy using multi-core by executing `make -j4`
$ sudo make install
```

### On Ubuntu using Catkin

#### Installing Dependencies

If [`wstool`][wstool] is available, you can use this `.rosinstall` file to
checkout Chimera, Boost.Python, Boost.NumPy/Eigen, and DART from source:
```yaml
- git:
    local-name: boost_numpy
    uri: https://github.com/personalrobotics/Boost.NumPy.git
    version: 0.0.1
- git:
    local-name: boost_numpy_eigen
    uri: https://github.com/personalrobotics/Boost.NumPy_Eigen.git
    version: 0.0.1
- git:
    local-name: chimera
    uri: https://github.com/personalrobotics/chimera.git
- git:
    local-name: dart
    uri: https://github.com/dartsim/dart.git
    version: release-6.3
- git:
    local-name: dartpy
    uri: https://github.com/personalrobotics/dartpy.git
```

If these packages are in a [Catkin workspace][catkin_workspace], you can follow
[these instructions][prl_dev] to use [`catkin-tools`][catkin_tools] to build
`dartpy` and its dependencies.

#### Building `dartpy`

If you are using `catkin_tools`, change your compiler to Clang 3.7 by running:
```console
$ catkin config -a --cmake-args -DCMAKE_C_COMPILER=$(which clang-3.7) -DCMAKE_CXX_COMPILER=$(which clang++-3.7)
```
Then, you follow the standard Catkin build process:
```console
$ catkin build
```

## Usage

Once `dartpy` is installed, you should be able to open a Python terminal and
`import dartpy`. Since `dartpy` is mostly auto-generated using Chimera, the
DART Python API mostly matches the DART C++ API.

There are a few exceptions:

### Template Functions

Template functions take the template parameters as regular arguments, e.g. the
C++ code:
```c++
auto joint = bodynode.moveTo<dart::dynamics::FreeJoint>(newParent);
```
becomes the Python code
```python
joint = bodynode.moveTo(dartpy.dynamics.FreeJoint, newParent)
```

Due to limitations of C++, this functionality requires the template arguments
to be registered with `dartpy`. Follow [the instructions below](#template-member-functions)
to register your custom types for use as template arguments.


## Usage: Bindings for Extension Libraries

### Template Member Functions
DART uses template member functions to construct `Addon`, `BodyNode`, and
`Joint` instances. `dartpy` works around this limitation by wrapping these
functions for a *predefined set* of template arguments. You need to *register*
your classes with `dartpy` for these methods to work on custom types.

For custom `Joint`s:
```c++
JointTemplateRegistry::register_type<MyJoint1>();
JointTemplateRegistry::register_type<MyJoint2>();
// ...
```

For custom `BodyNode`s:
```c++
BodyNodeTemplateRegistry::register_type<MyBodyNode1>();
BodyNodeTemplateRegistry::register_type<MyBodyNode2>();
BodyNodeTemplateRegistry::register_type<MyBodyNode3>();
// ...
```

If you want to use the `createJointAndBodyNodePair()` method on `Skeleton`,
then you also need to register *all pairs* of `BodyNode` and `Joint` subclasses
that you intend to pass as template arguments. Typically, this includes:

1. each custom `BodyNode` paired with each custom `Joint`
2. each custom `BodyNode` paired with each default `Joint`
3. each default `BodyNode` paired with each custom` Joint`

`dartpy` provides the `register_all_types` helper function to register the
cartesian product of two lists of types. You can register all of the above
combinations using the three lines of code:
```c++
using MyJointTypes = typelist<MyJoint1, MyJoint2 /* ... */>;
using MyBodyNodeTypes = typelist<MyBodyNode1, MyBodyNode2, MyBodyNode3 /* ... */>;

JointAndNodeTemplateRegistry::register_all_types<MyJointTypes, AllNodeTypes>();
JointAndNodeTemplateRegistry::register_all_types<AllJointTypes, MyBodyNodeTypes>();
JointAndNodeTemplateRegistry::register_all_types<MyJointTypes, MyBodyNodeTypes>();
```

Note that this approach means that is is not generally possible to call
`createJointAndBodyNodePair` with `BodyNode` and `Joint` types defined in two
different extension libraries. If this is necessary, you need to modify one of
the libraries to call `register_type` on that pair of `BodyNode` and `Joint`
types.

## License

`dartpy` is licensed under [the BSD-2-Clause license](https://opensource.org/licenses/BSD-2-Clause). See [LICENSE](https://github.com/personalrobotics/dartpy/blob/master/LICENSE) for more information.

## Authors

`dartpy` is developed by the [Personal Robotics Lab][prl] in the [Robotics
Institute][ri] at [Carnegie Mellon University][cmu] by [Michael Koval][mkoval]
([**@mkoval**][mkoval_github]) and [Pras Velagapudi][psigen]
([**@psigen**][psigen_github]).


[boost_numpy]: https://github.com/personalrobotics/Boost.NumPy
[boost_numpy_eigen]: https://github.com/personalrobotics/Boost.NumPy_Eigen
[chimera]: https://github.com/personalrobotics/chimera
[clang]: https://clang.llvm.org/
[cmake]: https://cmake.org/
[cmu]: http://www.cmu.edu
[dart]: http://dartsim.github.io/
[llvm_apt]: http://llvm.org/apt/
[mkoval]: http://mkoval.org
[mkoval_github]: https://github.com/mkoval
[prl]: https://personalrobotics.ri.cmu.edu
[prl_dev]: https://personalrobotics.cs.washington.edu/software/development-environment/
[psigen]: http://www.snowbotic.com/
[psigen_github]: http://github.com/psigen
[ri]: https://www.ri.cmu.edu
[ubuntu1404]: http://releases.ubuntu.com/14.04/
[wstool]: http://wiki.ros.org/wstool
[catkin_workspace]: http://wiki.ros.org/catkin/workspaces
[catkin_tools]: https://catkin-tools.readthedocs.org/en/latest/
